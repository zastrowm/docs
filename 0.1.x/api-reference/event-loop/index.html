
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
      <meta name="description" content="Documentation for Strands Agents, a simple-to-use, code-first, lightweight library for building AI agents">
    
    
    
    
      <link rel="prev" href="../agent/">
    
    
      <link rel="next" href="../handlers/">
    
    
    <link rel="icon" href="../../assets/logo-light.png" sizes="any">
    <link rel="icon" href="../../assets/logo-auto.svg" type="image/svg+xml">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">

    
      
        <title>Event Loop - Strands Agents SDK</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#strands.event_loop" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Strands Agents SDK" class="md-header__button md-logo" aria-label="Strands Agents SDK" data-md-component="logo">
      <!-- Logo -->

  <img src="../../assets/logo-light.svg" alt="logo" class="logo-light" />
  <img src="../../assets/logo-dark.svg" alt="logo" class="logo-dark" />

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Strands Agents SDK
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Event Loop
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/strands-agents/sdk-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="https://github.com/strands-agents/sdk-python/blob/main/CONTRIBUTING.md" class="md-tabs__link">
        
  
  
    
  
  Contribute ❤️

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../agent/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Strands Agents SDK" class="md-nav__button md-logo" aria-label="Strands Agents SDK" data-md-component="logo">
      <!-- Logo -->

  <img src="../../assets/logo-light.svg" alt="logo" class="logo-light" />
  <img src="../../assets/logo-dark.svg" alt="logo" class="logo-dark" />

    </a>
    Strands Agents SDK
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/strands-agents/sdk-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_1" >
        
          
          <label class="md-nav__link" for="__nav_1_3_1" id="__nav_1_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3_1">
            <span class="md-nav__icon md-icon"></span>
            Agents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/agents/agent-loop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent Loop
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/agents/sessions-state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sessions & State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/agents/prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/agents/context-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Context Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_2" >
        
          
          <label class="md-nav__link" for="__nav_1_3_2" id="__nav_1_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3_2">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/tools/tools_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/tools/python-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model Context Protocol (MCP)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/tools/example-tools-package/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Example Tools Package
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3_3" id="__nav_1_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Model Providers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3_3">
            <span class="md-nav__icon md-icon"></span>
            Model Providers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/amazon-bedrock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Bedrock
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/anthropic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anthropic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/litellm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LiteLLM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/llamaapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LlamaAPI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/ollama/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ollama
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/model-providers/custom_model_provider/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Providers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_4" >
        
          
          <label class="md-nav__link" for="__nav_1_3_4" id="__nav_1_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3_4">
            <span class="md-nav__icon md-icon"></span>
            Streaming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/streaming/async-iterators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Async Iterators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/streaming/callback-handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callback Handlers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3_5" >
        
          
          <label class="md-nav__link" for="__nav_1_3_5" id="__nav_1_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Multi-agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3_5">
            <span class="md-nav__icon md-icon"></span>
            Multi-agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/multi-agent/agents-as-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agents as Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/multi-agent/swarm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Swarm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/multi-agent/graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Graph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/concepts/multi-agent/workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Safety & Security
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Safety & Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safety-security/responsible-ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Responsible AI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safety-security/guardrails/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guardrails
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safety-security/prompt-engineering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Engineering
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" >
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Observability & Evaluation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            Observability & Evaluation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/observability-evaluation/observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/observability-evaluation/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/observability-evaluation/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Traces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/observability-evaluation/logs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/observability-evaluation/evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_6" >
        
          
          <label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Deploy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_6">
            <span class="md-nav__icon md-icon"></span>
            Deploy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/operating-agents-in-production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operating Agents in Production
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/deploy_to_aws_lambda/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Lambda
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/deploy_to_aws_fargate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Fargate
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/deploy_to_amazon_eks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon EKS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deploy/deploy_to_amazon_ec2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon EC2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/cli-reference-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI Reference Agent Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/weather_forecaster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Weather Forecaster
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/memory_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/file_operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Operations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/agents_workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agents Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/knowledge_base_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge-Base Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/multi_agent_example/multi_agent_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/meta_tooling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Meta Tooling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/python/mcp_calculator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/strands-agents/sdk-python/blob/main/CONTRIBUTING.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contribute ❤️
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Event Loop
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Event Loop
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop" class="md-nav__link">
    <span class="md-ellipsis">
      event_loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="event_loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.event_loop_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      event_loop_cycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.initialize_state" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.prepare_next_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_next_cycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.recurse_event_loop" class="md-nav__link">
    <span class="md-ellipsis">
      recurse_event_loop
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler" class="md-nav__link">
    <span class="md-ellipsis">
      error_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="error_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler.handle_input_too_long_error" class="md-nav__link">
    <span class="md-ellipsis">
      handle_input_too_long_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler.handle_throttling_error" class="md-nav__link">
    <span class="md-ellipsis">
      handle_throttling_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor" class="md-nav__link">
    <span class="md-ellipsis">
      message_processor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="message_processor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.clean_orphaned_empty_tool_uses" class="md-nav__link">
    <span class="md-ellipsis">
      clean_orphaned_empty_tool_uses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.find_last_message_with_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      find_last_message_with_tool_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.truncate_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      truncate_tool_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.streaming" class="md-nav__link">
    <span class="md-ellipsis">
      streaming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="streaming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.extract_usage_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      extract_usage_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_delta" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_delta
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_start" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_stop" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_message_start" class="md-nav__link">
    <span class="md-ellipsis">
      handle_message_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_message_stop" class="md-nav__link">
    <span class="md-ellipsis">
      handle_message_stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_redact_content" class="md-nav__link">
    <span class="md-ellipsis">
      handle_redact_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.process_stream" class="md-nav__link">
    <span class="md-ellipsis">
      process_stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.remove_blank_messages_content_text" class="md-nav__link">
    <span class="md-ellipsis">
      remove_blank_messages_content_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.stream_messages" class="md-nav__link">
    <span class="md-ellipsis">
      stream_messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handlers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../telemetry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Telemetry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Types
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop" class="md-nav__link">
    <span class="md-ellipsis">
      event_loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="event_loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.event_loop_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      event_loop_cycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.initialize_state" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.prepare_next_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_next_cycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.event_loop.recurse_event_loop" class="md-nav__link">
    <span class="md-ellipsis">
      recurse_event_loop
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler" class="md-nav__link">
    <span class="md-ellipsis">
      error_handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="error_handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler.handle_input_too_long_error" class="md-nav__link">
    <span class="md-ellipsis">
      handle_input_too_long_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.error_handler.handle_throttling_error" class="md-nav__link">
    <span class="md-ellipsis">
      handle_throttling_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor" class="md-nav__link">
    <span class="md-ellipsis">
      message_processor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="message_processor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.clean_orphaned_empty_tool_uses" class="md-nav__link">
    <span class="md-ellipsis">
      clean_orphaned_empty_tool_uses
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.find_last_message_with_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      find_last_message_with_tool_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.message_processor.truncate_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      truncate_tool_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strands.event_loop.streaming" class="md-nav__link">
    <span class="md-ellipsis">
      streaming
    </span>
  </a>
  
    <nav class="md-nav" aria-label="streaming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.extract_usage_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      extract_usage_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_delta" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_delta
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_start" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_content_block_stop" class="md-nav__link">
    <span class="md-ellipsis">
      handle_content_block_stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_message_start" class="md-nav__link">
    <span class="md-ellipsis">
      handle_message_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_message_stop" class="md-nav__link">
    <span class="md-ellipsis">
      handle_message_stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.handle_redact_content" class="md-nav__link">
    <span class="md-ellipsis">
      handle_redact_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.process_stream" class="md-nav__link">
    <span class="md-ellipsis">
      process_stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.remove_blank_messages_content_text" class="md-nav__link">
    <span class="md-ellipsis">
      remove_blank_messages_content_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strands.event_loop.streaming.stream_messages" class="md-nav__link">
    <span class="md-ellipsis">
      stream_messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div class="doc doc-object doc-module">



<h1 id="strands.event_loop" class="doc doc-heading">
            <code>strands.event_loop</code>


<a href="#strands.event_loop" class="headerlink" title="Permanent link">&para;</a></h1>

    <div class="doc doc-contents first">

        <p>This package provides the core event loop implementation for the agents SDK.</p>
<p>The event loop enables conversational AI agents to process messages, execute tools, and handle errors in a controlled,
iterative manner.</p>









  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="strands.event_loop.event_loop" class="doc doc-heading">
            <code>strands.event_loop.event_loop</code>


<a href="#strands.event_loop.event_loop" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>This module implements the central event loop.</p>
<p>The event loop allows agents to:</p>
<ol>
<li>Process conversation messages</li>
<li>Execute tools based on model requests</li>
<li>Handle errors and recovery strategies</li>
<li>Manage recursive execution cycles</li>
</ol>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.event_loop.event_loop_cycle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">event_loop_cycle</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tool_config</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">tool_handler</span><span class="p">,</span> <span class="n">tool_execution_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.event_loop.event_loop_cycle" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute a single cycle of the event loop.</p>
<p>This core function processes a single conversation turn, handling model inference, tool execution, and error
recovery. It manages the entire lifecycle of a conversation turn, including:</p>
<ol>
<li>Initializing cycle state and metrics</li>
<li>Checking execution limits</li>
<li>Processing messages with the model</li>
<li>Handling tool execution requests</li>
<li>Managing recursive calls for multi-turn tool interactions</li>
<li>Collecting and reporting metrics</li>
<li>Error handling and recovery</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Model (strands.types.models.Model)" href="../types/#strands.types.models.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Provider for running model inference.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>System prompt instructions for the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Conversation history messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ToolConfig (strands.types.tools.ToolConfig)" href="../types/#strands.types.tools.ToolConfig">ToolConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for available tools.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[..., <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_handler</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ToolHandler (strands.types.tools.ToolHandler)" href="../types/#strands.types.tools.ToolHandler">ToolHandler</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for executing tools.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_execution_handler</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ParallelToolExecutorInterface (strands.types.event_loop.ParallelToolExecutorInterface)" href="../types/#strands.types.event_loop.ParallelToolExecutorInterface">ParallelToolExecutorInterface</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional handler for parallel tool execution.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments including:</p>
<ul>
<li>event_loop_metrics: Metrics tracking object</li>
<li>request_state: State maintained across cycles</li>
<li>event_loop_cycle_id: Unique ID for this cycle</li>
<li>event_loop_cycle_span: Current tracing Span for this cycle</li>
<li>event_loop_parent_span: Parent tracing Span for this cycle</li>
</ul>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a>, <a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a>, <a class="autorefs autorefs-internal" title="EventLoopMetrics


  
      dataclass
   (strands.telemetry.metrics.EventLoopMetrics)" href="../telemetry/#strands.telemetry.metrics.EventLoopMetrics">EventLoopMetrics</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:</p>
<ul>
<li>StopReason: Reason the model stopped generating (e.g., "tool_use")</li>
<li>Message: The generated message from the model</li>
<li>EventLoopMetrics: Updated metrics for the event loop</li>
<li>Any: Updated request state</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="EventLoopException (strands.types.exceptions.EventLoopException)" href="../types/#strands.types.exceptions.EventLoopException">EventLoopException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an error occurs during execution</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ContextWindowOverflowException (strands.types.exceptions.ContextWindowOverflowException)" href="../types/#strands.types.exceptions.ContextWindowOverflowException">ContextWindowOverflowException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is too large for the model</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/event_loop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">event_loop_cycle</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span>
    <span class="n">tool_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolConfig</span><span class="p">],</span>
    <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">tool_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolHandler</span><span class="p">],</span>
    <span class="n">tool_execution_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ParallelToolExecutorInterface</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StopReason</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">EventLoopMetrics</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a single cycle of the event loop.</span>

<span class="sd">    This core function processes a single conversation turn, handling model inference, tool execution, and error</span>
<span class="sd">    recovery. It manages the entire lifecycle of a conversation turn, including:</span>

<span class="sd">    1. Initializing cycle state and metrics</span>
<span class="sd">    2. Checking execution limits</span>
<span class="sd">    3. Processing messages with the model</span>
<span class="sd">    4. Handling tool execution requests</span>
<span class="sd">    5. Managing recursive calls for multi-turn tool interactions</span>
<span class="sd">    6. Collecting and reporting metrics</span>
<span class="sd">    7. Error handling and recovery</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Provider for running model inference.</span>
<span class="sd">        system_prompt: System prompt instructions for the model.</span>
<span class="sd">        messages: Conversation history messages.</span>
<span class="sd">        tool_config: Configuration for available tools.</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        tool_handler: Handler for executing tools.</span>
<span class="sd">        tool_execution_handler: Optional handler for parallel tool execution.</span>
<span class="sd">        **kwargs: Additional arguments including:</span>

<span class="sd">            - event_loop_metrics: Metrics tracking object</span>
<span class="sd">            - request_state: State maintained across cycles</span>
<span class="sd">            - event_loop_cycle_id: Unique ID for this cycle</span>
<span class="sd">            - event_loop_cycle_span: Current tracing Span for this cycle</span>
<span class="sd">            - event_loop_parent_span: Parent tracing Span for this cycle</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing:</span>

<span class="sd">            - StopReason: Reason the model stopped generating (e.g., &quot;tool_use&quot;)</span>
<span class="sd">            - Message: The generated message from the model</span>
<span class="sd">            - EventLoopMetrics: Updated metrics for the event loop</span>
<span class="sd">            - Any: Updated request state</span>

<span class="sd">    Raises:</span>
<span class="sd">        EventLoopException: If an error occurs during execution</span>
<span class="sd">        ContextWindowOverflowException: If the input is too large for the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize cycle state</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_cycle_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

    <span class="n">event_loop_metrics</span><span class="p">:</span> <span class="n">EventLoopMetrics</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_loop_metrics&quot;</span><span class="p">,</span> <span class="n">EventLoopMetrics</span><span class="p">())</span>

    <span class="c1"># Initialize state and get cycle trace</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">initialize_state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cycle_start_time</span><span class="p">,</span> <span class="n">cycle_trace</span> <span class="o">=</span> <span class="n">event_loop_metrics</span><span class="o">.</span><span class="n">start_cycle</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_cycle_trace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cycle_trace</span>

    <span class="n">callback_handler</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">callback_handler</span><span class="p">(</span><span class="n">start_event_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create tracer span for this event loop cycle</span>
    <span class="n">tracer</span> <span class="o">=</span> <span class="n">get_tracer</span><span class="p">()</span>
    <span class="n">parent_span</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_loop_parent_span&quot;</span><span class="p">)</span>
    <span class="n">cycle_span</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_event_loop_cycle_span</span><span class="p">(</span>
        <span class="n">event_loop_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">parent_span</span><span class="o">=</span><span class="n">parent_span</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span>
    <span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_cycle_span&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cycle_span</span>

    <span class="c1"># Create a trace for the stream_messages call</span>
    <span class="n">stream_trace</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span><span class="s2">&quot;stream_messages&quot;</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">cycle_trace</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">cycle_trace</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">stream_trace</span><span class="p">)</span>

    <span class="c1"># Clean up orphaned empty tool uses</span>
    <span class="n">clean_orphaned_empty_tool_uses</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="c1"># Process messages with exponential backoff for throttling</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Message</span>
    <span class="n">stop_reason</span><span class="p">:</span> <span class="n">StopReason</span>
    <span class="n">usage</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Metrics</span>

    <span class="c1"># Retry loop for handling throttling exceptions</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ATTEMPTS</span><span class="p">):</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">model_invoke_span</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_model_invoke_span</span><span class="p">(</span>
            <span class="n">parent_span</span><span class="o">=</span><span class="n">cycle_span</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stop_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream_messages</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">tool_config</span><span class="p">,</span>
                <span class="n">callback_handler</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">model_invoke_span</span><span class="p">:</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">end_model_invoke_span</span><span class="p">(</span><span class="n">model_invoke_span</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">usage</span><span class="p">)</span>
            <span class="k">break</span>  <span class="c1"># Success! Break out of retry loop</span>

        <span class="k">except</span> <span class="n">ContextWindowOverflowException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_invoke_span</span><span class="p">:</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">end_span_with_error</span><span class="p">(</span><span class="n">model_invoke_span</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">handle_input_too_long_error</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">tool_config</span><span class="p">,</span>
                <span class="n">callback_handler</span><span class="p">,</span>
                <span class="n">tool_handler</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">ModelThrottledException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_invoke_span</span><span class="p">:</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">end_span_with_error</span><span class="p">(</span><span class="n">model_invoke_span</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Handle throttling errors with exponential backoff</span>
            <span class="n">should_retry</span><span class="p">,</span> <span class="n">current_delay</span> <span class="o">=</span> <span class="n">handle_throttling_error</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">MAX_ATTEMPTS</span><span class="p">,</span> <span class="n">INITIAL_DELAY</span><span class="p">,</span> <span class="n">MAX_DELAY</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">should_retry</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If not a throttling error or out of retries, re-raise</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_invoke_span</span><span class="p">:</span>
                <span class="n">tracer</span><span class="o">.</span><span class="n">end_span_with_error</span><span class="p">(</span><span class="n">model_invoke_span</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Add message in trace and mark the end of the stream messages trace</span>
        <span class="n">stream_trace</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">stream_trace</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="c1"># Add the response message to the conversation</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Update metrics</span>
        <span class="n">event_loop_metrics</span><span class="o">.</span><span class="n">update_usage</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
        <span class="n">event_loop_metrics</span><span class="o">.</span><span class="n">update_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># If the model is requesting to use tools</span>
        <span class="k">if</span> <span class="n">stop_reason</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_handler</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EventLoopException</span><span class="p">(</span>
                    <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model requested tool use but no tool handler provided&quot;</span><span class="p">),</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">tool_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EventLoopException</span><span class="p">(</span>
                    <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model requested tool use but no tool config provided&quot;</span><span class="p">),</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="c1"># Handle tool execution</span>
            <span class="k">return</span> <span class="n">_handle_tool_execution</span><span class="p">(</span>
                <span class="n">stop_reason</span><span class="p">,</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="p">,</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">tool_config</span><span class="p">,</span>
                <span class="n">tool_handler</span><span class="p">,</span>
                <span class="n">callback_handler</span><span class="p">,</span>
                <span class="n">tool_execution_handler</span><span class="p">,</span>
                <span class="n">event_loop_metrics</span><span class="p">,</span>
                <span class="n">cycle_trace</span><span class="p">,</span>
                <span class="n">cycle_span</span><span class="p">,</span>
                <span class="n">cycle_start_time</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># End the cycle and return results</span>
        <span class="n">event_loop_metrics</span><span class="o">.</span><span class="n">end_cycle</span><span class="p">(</span><span class="n">cycle_start_time</span><span class="p">,</span> <span class="n">cycle_trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cycle_span</span><span class="p">:</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">end_event_loop_cycle_span</span><span class="p">(</span>
                <span class="n">span</span><span class="o">=</span><span class="n">cycle_span</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="n">EventLoopException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cycle_span</span><span class="p">:</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">end_span_with_error</span><span class="p">(</span><span class="n">cycle_span</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Don&#39;t invoke the callback_handler or log the exception - we already did it when we</span>
        <span class="c1"># raised the exception and we don&#39;t need that duplication.</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cycle_span</span><span class="p">:</span>
            <span class="n">tracer</span><span class="o">.</span><span class="n">end_span_with_error</span><span class="p">(</span><span class="n">cycle_span</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Handle any other exceptions</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">force_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_stop_reason</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;cycle failed&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">EventLoopException</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">])</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">return</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">event_loop_metrics</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.event_loop.initialize_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.event_loop.initialize_state" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the request state if not present.</p>
<p>Creates an empty request_state dictionary if one doesn't already exist in the
provided keyword arguments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments that may contain a request_state.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated kwargs dictionary with request_state initialized if needed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/event_loop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the request state if not present.</span>

<span class="sd">    Creates an empty request_state dictionary if one doesn&#39;t already exist in the</span>
<span class="sd">    provided keyword arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        **kwargs: Keyword arguments that may contain a request_state.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated kwargs dictionary with request_state initialized if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;request_state&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.event_loop.prepare_next_cycle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_next_cycle</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">event_loop_metrics</span><span class="p">)</span></code>

<a href="#strands.event_loop.event_loop.prepare_next_cycle" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Prepare state for the next event loop cycle.</p>
<p>Updates the keyword arguments with the current event loop metrics and stores the current cycle ID as the parent
cycle ID for the next cycle. This maintains the parent-child relationship between cycles for tracing and metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current keyword arguments containing event loop state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>event_loop_metrics</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="EventLoopMetrics


  
      dataclass
   (strands.telemetry.metrics.EventLoopMetrics)" href="../telemetry/#strands.telemetry.metrics.EventLoopMetrics">EventLoopMetrics</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The metrics object tracking event loop execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated keyword arguments ready for the next cycle.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/event_loop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_next_cycle</span><span class="p">(</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">event_loop_metrics</span><span class="p">:</span> <span class="n">EventLoopMetrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare state for the next event loop cycle.</span>

<span class="sd">    Updates the keyword arguments with the current event loop metrics and stores the current cycle ID as the parent</span>
<span class="sd">    cycle ID for the next cycle. This maintains the parent-child relationship between cycles for tracing and metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        kwargs: Current keyword arguments containing event loop state.</span>
<span class="sd">        event_loop_metrics: The metrics object tracking event loop execution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated keyword arguments ready for the next cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store parent cycle ID</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_loop_metrics</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_parent_cycle_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_cycle_id&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.event_loop.recurse_event_loop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recurse_event_loop</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.event_loop.recurse_event_loop" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make a recursive call to event_loop_cycle with the current state.</p>
<p>This function is used when the event loop needs to continue processing after tool execution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments to pass to event_loop_cycle, including:</p>
<ul>
<li>model: Provider for running model inference</li>
<li>system_prompt: System prompt instructions for the model</li>
<li>messages: Conversation history messages</li>
<li>tool_config: Configuration for available tools</li>
<li>callback_handler: Callback for processing events as they happen</li>
<li>tool_handler: Handler for tool execution</li>
<li>event_loop_cycle_trace: Trace for the current cycle</li>
<li>event_loop_metrics: Metrics tracking object</li>
</ul>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a>, <a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a>, <a class="autorefs autorefs-internal" title="EventLoopMetrics


  
      dataclass
   (strands.telemetry.metrics.EventLoopMetrics)" href="../telemetry/#strands.telemetry.metrics.EventLoopMetrics">EventLoopMetrics</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Results from event_loop_cycle:</p>
<ul>
<li>StopReason: Reason the model stopped generating</li>
<li>Message: The generated message from the model</li>
<li>EventLoopMetrics: Updated metrics for the event loop</li>
<li>Any: Updated request state</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/event_loop.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">recurse_event_loop</span><span class="p">(</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StopReason</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">EventLoopMetrics</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a recursive call to event_loop_cycle with the current state.</span>

<span class="sd">    This function is used when the event loop needs to continue processing after tool execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        **kwargs: Arguments to pass to event_loop_cycle, including:</span>

<span class="sd">            - model: Provider for running model inference</span>
<span class="sd">            - system_prompt: System prompt instructions for the model</span>
<span class="sd">            - messages: Conversation history messages</span>
<span class="sd">            - tool_config: Configuration for available tools</span>
<span class="sd">            - callback_handler: Callback for processing events as they happen</span>
<span class="sd">            - tool_handler: Handler for tool execution</span>
<span class="sd">            - event_loop_cycle_trace: Trace for the current cycle</span>
<span class="sd">            - event_loop_metrics: Metrics tracking object</span>

<span class="sd">    Returns:</span>
<span class="sd">        Results from event_loop_cycle:</span>

<span class="sd">            - StopReason: Reason the model stopped generating</span>
<span class="sd">            - Message: The generated message from the model</span>
<span class="sd">            - EventLoopMetrics: Updated metrics for the event loop</span>
<span class="sd">            - Any: Updated request state</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cycle_trace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;event_loop_cycle_trace&quot;</span><span class="p">]</span>
    <span class="n">callback_handler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;callback_handler&quot;</span><span class="p">]</span>

    <span class="c1"># Recursive call trace</span>
    <span class="n">recursive_trace</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span><span class="s2">&quot;Recursive call&quot;</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">cycle_trace</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">cycle_trace</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">recursive_trace</span><span class="p">)</span>

    <span class="n">callback_handler</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Make recursive call</span>
    <span class="p">(</span>
        <span class="n">recursive_stop_reason</span><span class="p">,</span>
        <span class="n">recursive_message</span><span class="p">,</span>
        <span class="n">recursive_event_loop_metrics</span><span class="p">,</span>
        <span class="n">recursive_request_state</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">event_loop_cycle</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">recursive_trace</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">recursive_stop_reason</span><span class="p">,</span>
        <span class="n">recursive_message</span><span class="p">,</span>
        <span class="n">recursive_event_loop_metrics</span><span class="p">,</span>
        <span class="n">recursive_request_state</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="strands.event_loop.error_handler" class="doc doc-heading">
            <code>strands.event_loop.error_handler</code>


<a href="#strands.event_loop.error_handler" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>This module provides specialized error handlers for common issues that may occur during event loop execution.</p>
<p>Examples include throttling exceptions and context window overflow errors. These handlers implement recovery strategies
like exponential backoff for throttling and message truncation for context window limitations.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.error_handler.handle_input_too_long_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_input_too_long_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">,</span> <span class="n">tool_config</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">tool_handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.error_handler.handle_input_too_long_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handle 'Input is too long' errors by truncating tool results.</p>
<p>When a context window overflow exception occurs (input too long for the model), this function attempts to recover
by finding and truncating the most recent tool results in the conversation history. If truncation is successful, the
function will make a call to the event loop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>e</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ContextWindowOverflowException (strands.types.exceptions.ContextWindowOverflowException)" href="../types/#strands.types.exceptions.ContextWindowOverflowException">ContextWindowOverflowException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ContextWindowOverflowException that occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The conversation message history.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Model (strands.types.models.Model)" href="../types/#strands.types.models.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model provider for running inference.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>System prompt for the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_config</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tool configuration for the conversation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler for tool execution.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the event loop.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a>, <a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a>, <a class="autorefs autorefs-internal" title="EventLoopMetrics


  
      dataclass
   (strands.telemetry.metrics.EventLoopMetrics)" href="../telemetry/#strands.telemetry.metrics.EventLoopMetrics">EventLoopMetrics</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The results from the event loop call if successful.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ContextWindowOverflowException (strands.types.exceptions.ContextWindowOverflowException)" href="../types/#strands.types.exceptions.ContextWindowOverflowException">ContextWindowOverflowException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If messages cannot be truncated.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/error_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_input_too_long_error</span><span class="p">(</span>
    <span class="n">e</span><span class="p">:</span> <span class="n">ContextWindowOverflowException</span><span class="p">,</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tool_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">tool_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StopReason</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">EventLoopMetrics</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle &#39;Input is too long&#39; errors by truncating tool results.</span>

<span class="sd">    When a context window overflow exception occurs (input too long for the model), this function attempts to recover</span>
<span class="sd">    by finding and truncating the most recent tool results in the conversation history. If truncation is successful, the</span>
<span class="sd">    function will make a call to the event loop.</span>

<span class="sd">    Args:</span>
<span class="sd">        e: The ContextWindowOverflowException that occurred.</span>
<span class="sd">        messages: The conversation message history.</span>
<span class="sd">        model: Model provider for running inference.</span>
<span class="sd">        system_prompt: System prompt for the model.</span>
<span class="sd">        tool_config: Tool configuration for the conversation.</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        tool_handler: Handler for tool execution.</span>
<span class="sd">        kwargs: Additional arguments for the event loop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The results from the event loop call if successful.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ContextWindowOverflowException: If messages cannot be truncated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.event_loop</span><span class="w"> </span><span class="kn">import</span> <span class="n">recurse_event_loop</span>  <span class="c1"># Import here to avoid circular imports</span>

    <span class="c1"># Find the last message with tool results</span>
    <span class="n">last_message_with_tool_results</span> <span class="o">=</span> <span class="n">find_last_message_with_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="c1"># If we found a message with toolResult</span>
    <span class="k">if</span> <span class="n">last_message_with_tool_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message_index=&lt;</span><span class="si">%s</span><span class="s2">&gt; | found message with tool results at index&quot;</span><span class="p">,</span> <span class="n">last_message_with_tool_results</span><span class="p">)</span>

        <span class="c1"># Truncate the tool results in this message</span>
        <span class="n">truncate_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">last_message_with_tool_results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recurse_event_loop</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">tool_config</span><span class="o">=</span><span class="n">tool_config</span><span class="p">,</span>
            <span class="n">callback_handler</span><span class="o">=</span><span class="n">callback_handler</span><span class="p">,</span>
            <span class="n">tool_handler</span><span class="o">=</span><span class="n">tool_handler</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># If we can&#39;t handle this error, pass it up</span>
    <span class="n">callback_handler</span><span class="p">(</span><span class="n">force_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_stop_reason</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;an exception occurred in event_loop_cycle | </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">ContextWindowOverflowException</span><span class="p">()</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.error_handler.handle_throttling_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_throttling_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">,</span> <span class="n">current_delay</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.error_handler.handle_throttling_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handle throttling exceptions from the model provider with exponential backoff.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>e</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelThrottledException (strands.types.exceptions.ModelThrottledException)" href="../types/#strands.types.exceptions.ModelThrottledException">ModelThrottledException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The exception that occurred during model invocation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attempt</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of times event loop has attempted model invocation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_attempts</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of retry attempts allowed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_delay</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current delay in seconds before retrying.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_delay</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum delay in seconds (cap for exponential growth).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments to pass to the callback handler.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="bool">bool</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- bool: True if retry should be attempted, False otherwise
- int: The new delay to use for the next retry attempt</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/error_handler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_throttling_error</span><span class="p">(</span>
    <span class="n">e</span><span class="p">:</span> <span class="n">ModelThrottledException</span><span class="p">,</span>
    <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">current_delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_delay</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle throttling exceptions from the model provider with exponential backoff.</span>

<span class="sd">    Args:</span>
<span class="sd">        e: The exception that occurred during model invocation.</span>
<span class="sd">        attempt: Number of times event loop has attempted model invocation.</span>
<span class="sd">        max_attempts: Maximum number of retry attempts allowed.</span>
<span class="sd">        current_delay: Current delay in seconds before retrying.</span>
<span class="sd">        max_delay: Maximum delay in seconds (cap for exponential growth).</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        kwargs: Additional arguments to pass to the callback handler.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">            - bool: True if retry should be attempted, False otherwise</span>
<span class="sd">            - int: The new delay to use for the next retry attempt</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_attempts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Don&#39;t sleep on last attempt</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;retry_delay_seconds=&lt;</span><span class="si">%s</span><span class="s2">&gt;, max_attempts=&lt;</span><span class="si">%s</span><span class="s2">&gt;, current_attempt=&lt;</span><span class="si">%s</span><span class="s2">&gt; &quot;</span>
            <span class="s2">&quot;| throttling exception encountered &quot;</span>
            <span class="s2">&quot;| delaying before next retry&quot;</span><span class="p">,</span>
            <span class="n">current_delay</span><span class="p">,</span>
            <span class="n">max_attempts</span><span class="p">,</span>
            <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">event_loop_throttled_delay</span><span class="o">=</span><span class="n">current_delay</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">current_delay</span><span class="p">)</span>
        <span class="n">new_delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_delay</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">)</span>  <span class="c1"># Double delay each retry</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">new_delay</span>

    <span class="n">callback_handler</span><span class="p">(</span><span class="n">force_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_stop_reason</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">current_delay</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="strands.event_loop.message_processor" class="doc doc-heading">
            <code>strands.event_loop.message_processor</code>


<a href="#strands.event_loop.message_processor" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>This module provides utilities for processing and manipulating conversation messages within the event loop.</p>
<p>It includes functions for cleaning up orphaned tool uses, finding messages with specific content types, and truncating
large tool results to prevent context window overflow.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.message_processor.clean_orphaned_empty_tool_uses" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_orphaned_empty_tool_uses</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span></code>

<a href="#strands.event_loop.message_processor.clean_orphaned_empty_tool_uses" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Clean up orphaned empty tool uses in conversation messages.</p>
<p>This function identifies and removes any toolUse entries with empty input that don't have a corresponding
toolResult. This prevents validation errors that occur when the model expects matching toolResult blocks for each
toolUse.</p>
<p>The function applies fixes by either:</p>
<ol>
<li>Replacing a message containing only an orphaned toolUse with a context message</li>
<li>Removing the orphaned toolUse entry from a message with multiple content items</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The conversation message history.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if any fixes were applied, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/message_processor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_orphaned_empty_tool_uses</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up orphaned empty tool uses in conversation messages.</span>

<span class="sd">    This function identifies and removes any toolUse entries with empty input that don&#39;t have a corresponding</span>
<span class="sd">    toolResult. This prevents validation errors that occur when the model expects matching toolResult blocks for each</span>
<span class="sd">    toolUse.</span>

<span class="sd">    The function applies fixes by either:</span>

<span class="sd">    1. Replacing a message containing only an orphaned toolUse with a context message</span>
<span class="sd">    2. Removing the orphaned toolUse entry from a message with multiple content items</span>

<span class="sd">    Args:</span>
<span class="sd">        messages: The conversation message history.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if any fixes were applied, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Dictionary to track empty toolUse entries: {tool_id: (msg_index, content_index, tool_name)}</span>
    <span class="n">empty_tool_uses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Set to track toolResults that have been seen</span>
    <span class="n">tool_results</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Identify empty toolUse entries</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;toolUse&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">tool_use</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toolUse&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">tool_id</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toolUseId&quot;</span><span class="p">)</span>
                <span class="n">tool_input</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">tool_name</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown tool&quot;</span><span class="p">)</span>

                <span class="c1"># Check if this is an empty toolUse</span>
                <span class="k">if</span> <span class="n">tool_id</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tool_input</span> <span class="ow">or</span> <span class="n">tool_input</span> <span class="o">==</span> <span class="p">{}):</span>
                    <span class="n">empty_tool_uses</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">)</span>

    <span class="c1"># Identify toolResults</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;toolResult&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">tool_result</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toolResult&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">tool_id</span> <span class="o">=</span> <span class="n">tool_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toolUseId&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tool_id</span><span class="p">:</span>
                    <span class="n">tool_results</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tool_id</span><span class="p">)</span>

    <span class="c1"># Filter for orphaned empty toolUses (no corresponding toolResult)</span>
    <span class="n">orphaned_tool_uses</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool_id</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">tool_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">empty_tool_uses</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">tool_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tool_results</span><span class="p">}</span>

    <span class="c1"># Apply fixes in reverse order of occurrence (to avoid index shifting)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orphaned_tool_uses</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Sort by message index and content index in reverse order</span>
    <span class="n">sorted_orphaned</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">orphaned_tool_uses</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Apply fixes</span>
    <span class="k">for</span> <span class="n">tool_id</span><span class="p">,</span> <span class="p">(</span><span class="n">msg_idx</span><span class="p">,</span> <span class="n">content_idx</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_orphaned</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;tool_name=&lt;</span><span class="si">%s</span><span class="s2">&gt;, tool_id=&lt;</span><span class="si">%s</span><span class="s2">&gt;, message_index=&lt;</span><span class="si">%s</span><span class="s2">&gt;, content_index=&lt;</span><span class="si">%s</span><span class="s2">&gt; &quot;</span>
            <span class="s2">&quot;fixing orphaned empty tool use at message index&quot;</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_id</span><span class="p">,</span>
            <span class="n">msg_idx</span><span class="p">,</span>
            <span class="n">content_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if this is the sole content in the message</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Replace with a message indicating the attempted tool</span>
                <span class="n">messages</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[Attempted to use </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">, but operation was canceled]&quot;</span><span class="p">}]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;message_index=&lt;</span><span class="si">%s</span><span class="s2">&gt; | replaced content with context message&quot;</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Simply remove the orphaned toolUse entry</span>
                <span class="n">messages</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">content_idx</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;message_index=&lt;</span><span class="si">%s</span><span class="s2">&gt;, content_index=&lt;</span><span class="si">%s</span><span class="s2">&gt; | removed content item from message&quot;</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">,</span> <span class="n">content_idx</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failed to fix orphaned tool use | </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.message_processor.find_last_message_with_tool_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_last_message_with_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span></code>

<a href="#strands.event_loop.message_processor.find_last_message_with_tool_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Find the index of the last message containing tool results.</p>
<p>This is useful for identifying messages that might need to be truncated to reduce context size.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The conversation message history.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the last message with tool results, or None if no such message exists.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/message_processor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_last_message_with_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the index of the last message containing tool results.</span>

<span class="sd">    This is useful for identifying messages that might need to be truncated to reduce context size.</span>

<span class="sd">    Args:</span>
<span class="sd">        messages: The conversation message history.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Index of the last message with tool results, or None if no such message exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Iterate backwards through all messages (from newest to oldest)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Check if this message has any content with toolResult</span>
        <span class="n">current_message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">has_tool_result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">current_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;toolResult&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">has_tool_result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">has_tool_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idx</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.message_processor.truncate_tool_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">truncate_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">)</span></code>

<a href="#strands.event_loop.message_processor.truncate_tool_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Truncate tool results in a message to reduce context size.</p>
<p>When a message contains tool results that are too large for the model's context window, this function replaces the
content of those tool results with a simple error message.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The conversation message history.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>msg_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the message containing tool results to truncate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if any changes were made to the message, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/message_processor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">truncate_tool_results</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Truncate tool results in a message to reduce context size.</span>

<span class="sd">    When a message contains tool results that are too large for the model&#39;s context window, this function replaces the</span>
<span class="sd">    content of those tool results with a simple error message.</span>

<span class="sd">    Args:</span>
<span class="sd">        messages: The conversation message history.</span>
<span class="sd">        msg_idx: Index of the message containing tool results to truncate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if any changes were made to the message, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">msg_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">]</span>
    <span class="n">changes_made</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[])):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;toolResult&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="c1"># Update status to error with informative message</span>
            <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;toolResult&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;toolResult&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;The tool result was too large!&quot;</span><span class="p">}]</span>
            <span class="n">changes_made</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">changes_made</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="strands.event_loop.streaming" class="doc doc-heading">
            <code>strands.event_loop.streaming</code>


<a href="#strands.event_loop.streaming" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Utilities for handling streaming responses from language models.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.extract_usage_metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_usage_metrics</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.extract_usage_metrics" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Extracts usage metrics from the metadata chunk.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MetadataEvent (strands.types.streaming.MetadataEvent)" href="../types/#strands.types.streaming.MetadataEvent">MetadataEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>metadata.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="Usage (strands.types.streaming.Usage)" href="../types/#strands.types.event_loop.Usage">Usage</a>, <a class="autorefs autorefs-internal" title="Metrics (strands.types.streaming.Metrics)" href="../types/#strands.types.event_loop.Metrics">Metrics</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The extracted usage metrics and latency.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_usage_metrics</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MetadataEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Usage</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts usage metrics from the metadata chunk.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: metadata.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The extracted usage metrics and latency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="n">Usage</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;usage&quot;</span><span class="p">])</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">usage</span><span class="p">,</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_content_block_delta" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_content_block_delta</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_content_block_delta" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles content block delta updates by appending text, tool input, or reasoning content to the state.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ContentBlockDeltaEvent (strands.types.streaming.ContentBlockDeltaEvent)" href="../types/#strands.types.streaming.ContentBlockDeltaEvent">ContentBlockDeltaEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Delta event.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of message processing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to pass to the callback handler.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated state with appended text or tool input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_content_block_delta</span><span class="p">(</span>
    <span class="n">event</span><span class="p">:</span> <span class="n">ContentBlockDeltaEvent</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles content block delta updates by appending text, tool input, or reasoning content to the state.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: Delta event.</span>
<span class="sd">        state: The current state of message processing.</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the callback handler.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated state with appended text or tool input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delta_content</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;toolUse&quot;</span> <span class="ow">in</span> <span class="n">delta_content</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">]:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;toolUse&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta_content</span><span class="p">,</span> <span class="n">current_tool_use</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">delta_content</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta_content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;reasoningContent&quot;</span> <span class="ow">in</span> <span class="n">delta_content</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;reasoningText&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reasoningText&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reasoningText&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            <span class="n">callback_handler</span><span class="p">(</span>
                <span class="n">reasoningText</span><span class="o">=</span><span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">delta_content</span><span class="p">,</span>
                <span class="n">reasoning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;signature&quot;</span> <span class="ow">in</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;signature&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="s2">&quot;signature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;signature&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">][</span><span class="s2">&quot;signature&quot;</span><span class="p">]</span>
            <span class="n">callback_handler</span><span class="p">(</span>
                <span class="n">reasoning_signature</span><span class="o">=</span><span class="n">delta_content</span><span class="p">[</span><span class="s2">&quot;reasoningContent&quot;</span><span class="p">][</span><span class="s2">&quot;signature&quot;</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">delta_content</span><span class="p">,</span>
                <span class="n">reasoning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_content_block_start" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_content_block_start</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_content_block_start" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles the start of a content block by extracting tool usage information if any.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ContentBlockStartEvent (strands.types.streaming.ContentBlockStartEvent)" href="../types/#strands.types.streaming.ContentBlockStartEvent">ContentBlockStartEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start event.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with tool use id and name if tool use request, empty dictionary otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_content_block_start</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">ContentBlockStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles the start of a content block by extracting tool usage information if any.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: Start event.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with tool use id and name if tool use request, empty dictionary otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">ContentBlockStart</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
    <span class="n">current_tool_use</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;toolUse&quot;</span> <span class="ow">in</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;toolUse&quot;</span><span class="p">]:</span>
        <span class="n">tool_use_data</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;toolUse&quot;</span><span class="p">]</span>
        <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;toolUseId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_use_data</span><span class="p">[</span><span class="s2">&quot;toolUseId&quot;</span><span class="p">]</span>
        <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_use_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">current_tool_use</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_content_block_stop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_content_block_stop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_content_block_stop" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles the end of a content block by finalizing tool usage, text content, or reasoning content.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of message processing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated state with finalized content block.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_content_block_stop</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles the end of a content block by finalizing tool usage, text content, or reasoning content.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The current state of message processing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated state with finalized content block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>

    <span class="n">current_tool_use</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
    <span class="n">reasoning_text</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reasoningText&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">current_tool_use</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_tool_use</span><span class="p">:</span>
            <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tool_use_id</span> <span class="o">=</span> <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;toolUseId&quot;</span><span class="p">]</span>
        <span class="n">tool_use_name</span> <span class="o">=</span> <span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="n">tool_use</span> <span class="o">=</span> <span class="n">ToolUse</span><span class="p">(</span>
            <span class="n">toolUseId</span><span class="o">=</span><span class="n">tool_use_id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">tool_use_name</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">current_tool_use</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;toolUse&quot;</span><span class="p">:</span> <span class="n">tool_use</span><span class="p">})</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">elif</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">})</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">elif</span> <span class="n">reasoning_text</span><span class="p">:</span>
        <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;reasoningContent&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;reasoningText&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reasoningText&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;signature&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;reasoningText&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_message_start" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_message_start</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_message_start" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles the start of a message by setting the role in the message dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageStartEvent (strands.types.streaming.MessageStartEvent)" href="../types/#strands.types.streaming.MessageStartEvent">MessageStartEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A message start event.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>message</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The message dictionary being constructed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated message dictionary with the role set.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_message_start</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MessageStartEvent</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles the start of a message by setting the role in the message dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: A message start event.</span>
<span class="sd">        message: The message dictionary being constructed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated message dictionary with the role set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">message</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_message_stop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_message_stop</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_message_stop" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles the end of a message by returning the stop reason.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageStopEvent (strands.types.streaming.MessageStopEvent)" href="../types/#strands.types.streaming.MessageStopEvent">MessageStopEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stop event.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reason for stopping the stream.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_message_stop</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MessageStopEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StopReason</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles the end of a message by returning the stop reason.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: Stop event.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The reason for stopping the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;stopReason&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.handle_redact_content" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_redact_content</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.handle_redact_content" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handles redacting content from the input or output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="RedactContentEvent (strands.types.streaming.RedactContentEvent)" href="../types/#strands.types.streaming.RedactContentEvent">RedactContentEvent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redact Content Event.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of message processing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_redact_content</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">RedactContentEvent</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles redacting content from the input or output.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: Redact Content Event.</span>
<span class="sd">        messages: Agent messages.</span>
<span class="sd">        state: The current state of message processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redactUserContentMessage&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;redactUserContentMessage&quot;</span><span class="p">]}]</span>  <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;redactAssistantContentMessage&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;redactAssistantContentMessage&quot;</span><span class="p">]}]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.process_stream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_stream</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.process_stream" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Processes the response stream from the API, constructing the final message and extracting usage metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunks</code>
            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<a class="autorefs autorefs-internal" title="StreamEvent (strands.types.streaming.StreamEvent)" href="../types/#strands.types.streaming.StreamEvent">StreamEvent</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chunks of the response stream from the model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agents messages.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that will be passed to the callback handler.
And also returned in the request_state.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a>, <a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a>, <a class="autorefs autorefs-internal" title="Usage (strands.types.streaming.Usage)" href="../types/#strands.types.event_loop.Usage">Usage</a>, <a class="autorefs autorefs-internal" title="Metrics (strands.types.streaming.Metrics)" href="../types/#strands.types.event_loop.Metrics">Metrics</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reason for stopping, the constructed message, the usage metrics, and the updated request state.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_stream</span><span class="p">(</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">StreamEvent</span><span class="p">],</span>
    <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StopReason</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Usage</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes the response stream from the API, constructing the final message and extracting usage metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        chunks: The chunks of the response stream from the model.</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        messages: The agents messages.</span>
<span class="sd">        **kwargs: Additional keyword arguments that will be passed to the callback handler.</span>
<span class="sd">            And also returned in the request_state.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The reason for stopping, the constructed message, the usage metrics, and the updated request state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stop_reason</span><span class="p">:</span> <span class="n">StopReason</span> <span class="o">=</span> <span class="s2">&quot;end_turn&quot;</span>

    <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;current_tool_use&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;reasoningText&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>

    <span class="n">usage</span><span class="p">:</span> <span class="n">Usage</span> <span class="o">=</span> <span class="n">Usage</span><span class="p">(</span><span class="n">inputTokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">outputTokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">totalTokens</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">latencyMs</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;request_state&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="c1"># Callback handler call here allows each event to be visible to the caller</span>
        <span class="n">callback_handler</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;messageStart&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_message_start</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;messageStart&quot;</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;contentBlockStart&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_tool_use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle_content_block_start</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;contentBlockStart&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;contentBlockDelta&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">handle_content_block_delta</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;contentBlockDelta&quot;</span><span class="p">],</span> <span class="n">state</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;contentBlockStop&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">handle_content_block_stop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;messageStop&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">stop_reason</span> <span class="o">=</span> <span class="n">handle_message_stop</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;messageStop&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">usage</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">extract_usage_metrics</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s2">&quot;redactContent&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">handle_redact_content</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;redactContent&quot;</span><span class="p">],</span> <span class="n">messages</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="n">usage</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;request_state&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.remove_blank_messages_content_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_blank_messages_content_text</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.remove_blank_messages_content_text" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Remove or replace blank text in message content.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Conversation messages to update.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Updated messages.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_blank_messages_content_text</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove or replace blank text in message content.</span>

<span class="sd">    Args:</span>
<span class="sd">        messages: Conversation messages to update.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">removed_blank_message_content_text</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">replaced_blank_message_content_text</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="c1"># only modify assistant messages</span>
        <span class="k">if</span> <span class="s2">&quot;role&quot;</span> <span class="ow">in</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="n">has_tool_use</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;toolUse&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_tool_use</span><span class="p">:</span>
                <span class="c1"># Remove blank &#39;text&#39; items for assistant messages</span>
                <span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">removed_blank_message_content_text</span> <span class="ow">and</span> <span class="n">before_len</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                    <span class="n">removed_blank_message_content_text</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Replace blank &#39;text&#39; with &#39;[blank text]&#39; for assistant messages</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">replaced_blank_message_content_text</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;[blank text]&quot;</span>

    <span class="k">if</span> <span class="n">removed_blank_message_content_text</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;removed blank message context text&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">replaced_blank_message_content_text</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;replaced blank message context text&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">messages</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="strands.event_loop.streaming.stream_messages" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stream_messages</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">tool_config</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#strands.event_loop.streaming.stream_messages" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Streams messages to the model and processes the response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Model (strands.types.models.Model)" href="../types/#strands.types.models.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model provider.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The system prompt to send.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>messages</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Messages = List[Message]

  
      module-attribute
   (strands.types.content.Messages)" href="../types/#strands.types.content.Messages">Messages</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of messages to send.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_config</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ToolConfig (strands.types.tools.ToolConfig)" href="../types/#strands.types.tools.ToolConfig">ToolConfig</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for the tools to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callback_handler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback for processing events as they happen.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that will be passed to the callback handler.
And also returned in the request_state.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="StopReason = Literal['content_filtered', 'end_turn', 'guardrail_intervened', 'max_tokens', 'stop_sequence', 'tool_use']

  
      module-attribute
   (strands.types.streaming.StopReason)" href="../types/#strands.types.event_loop.StopReason">StopReason</a>, <a class="autorefs autorefs-internal" title="Message (strands.types.content.Message)" href="../types/#strands.types.content.Message">Message</a>, <a class="autorefs autorefs-internal" title="Usage (strands.types.streaming.Usage)" href="../types/#strands.types.event_loop.Usage">Usage</a>, <a class="autorefs autorefs-internal" title="Metrics (strands.types.streaming.Metrics)" href="../types/#strands.types.event_loop.Metrics">Metrics</a>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reason for stopping, the final message, the usage metrics, and updated request state.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>strands/event_loop/streaming.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream_messages</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span>
    <span class="n">tool_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolConfig</span><span class="p">],</span>
    <span class="n">callback_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">StopReason</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Usage</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Streams messages to the model and processes the response.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Model provider.</span>
<span class="sd">        system_prompt: The system prompt to send.</span>
<span class="sd">        messages: List of messages to send.</span>
<span class="sd">        tool_config: Configuration for the tools to use.</span>
<span class="sd">        callback_handler: Callback for processing events as they happen.</span>
<span class="sd">        **kwargs: Additional keyword arguments that will be passed to the callback handler.</span>
<span class="sd">            And also returned in the request_state.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The reason for stopping, the final message, the usage metrics, and updated request state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;model=&lt;</span><span class="si">%s</span><span class="s2">&gt; | streaming messages&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="n">remove_blank_messages_content_text</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
    <span class="n">tool_specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="p">[</span><span class="s2">&quot;toolSpec&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tool_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[])]</span> <span class="ow">or</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">tool_config</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">converse</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tool_specs</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">process_stream</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">callback_handler</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.select", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../assets/external/unpkg.com/mermaid@11/dist/mermaid.min.js"></script>
      
    
  </body>
</html>