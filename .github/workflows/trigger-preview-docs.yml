name: Trigger Preview Deployment

on:
  pull_request_target:
    branches: [main]

jobs:
  authorization-check:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.collab-check.outputs.result }}
    steps:
      - name: Collaborator Check
        uses: actions/github-script@v8
        id: collab-check
        with:
          result-encoding: string
          script: |
            try {
              const permissionResponse = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.pull_request.user.login,
              });
              const permission = permissionResponse.data.permission;
              const hasWriteAccess = ['write', 'admin'].includes(permission);
              
              if (!hasWriteAccess) {
                console.log(`User ${context.payload.pull_request.user.login} does not have write access to the repository (permission: ${permission})`);
                return "false"
              } else {
                console.log(`Verified ${context.payload.pull_request.user.login} has write access. Approving documentation deployment.`)
                return "true"
              }
            } catch (error) {
              console.log(`${context.payload.pull_request.user.login} does not have write access. Denying documentation deployment.`)
              return "false"
            }

  trigger-docs-deploy:
    runs-on: ubuntu-latest
    needs: [authorization-check]
    if: needs.authorization-check.outputs.should-deploy == 'true'
    
    steps:
      - name: Trigger documentation deployment
        env:
          # PAT token with 'repo' scope needed to trigger repository_dispatch events in other repositories
          GH_TOKEN: ${{ secrets.PREVIEWS_PAT_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository_owner }}/strandsagents.com/dispatches \
            -f event_type=deploy-docs \
            -F "client_payload[source_repo]=${{ github.event.pull_request.head.repo.full_name }}" \
            -F "client_payload[sha]=${{ github.event.pull_request.head.sha }}" \
            -F "client_payload[pr_number]=${{ github.event.pull_request.number }}"
          
          echo "Deployment triggered successfully"
