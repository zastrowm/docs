---
/**
 * Custom Head override to add Mermaid diagram support.
 * See ARCHITECTURE.md for details.
 */
const { head } = Astro.locals.starlightRoute
---

{head.map(({ tag: Tag, attrs, content }) => <Tag {...attrs} set:html={content} />)}

<script>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs'

  // Transform Expressive Code mermaid blocks into mermaid.js format and render
  document.querySelectorAll('pre[data-language="mermaid"]').forEach((pre) => {
    const diagram = [...pre.querySelectorAll('code > .ec-line')].map((it) => it.textContent).join('\n')
    const div = document.createElement('pre')
    div.className = 'mermaid'
    div.textContent = diagram
    pre.replaceWith(div)
  })

  const isDark = document.documentElement.dataset.theme === 'dark'
  mermaid.initialize({ startOnLoad: false, theme: isDark ? 'dark' : 'neutral' })
  mermaid.run()
</script>
